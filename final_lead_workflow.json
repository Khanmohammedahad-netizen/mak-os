{
    "name": "MAK Software - Production Lead Engine v2",
    "nodes": [
        {
            "name": "Schedule Trigger",
            "type": "n8n-nodes-base.scheduleTrigger",
            "position": [
                250,
                400
            ],
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "hours",
                            "hoursInterval": 24
                        }
                    ]
                },
                "triggerTimes": {
                    "item": [
                        {
                            "hour": 9,
                            "minute": 0
                        }
                    ]
                }
            }
        },
        {
            "name": "Manual Webhook",
            "type": "n8n-nodes-base.webhook",
            "position": [
                250,
                600
            ],
            "parameters": {
                "path": "lead-discovery",
                "responseMode": "lastNode",
                "httpMethod": "POST"
            },
            "webhookId": "lead-discovery"
        },
        {
            "name": "Initialize Regions",
            "type": "n8n-nodes-base.code",
            "position": [
                500,
                500
            ],
            "parameters": {
                "jsCode": "const regions = [\n  {region: 'UK', lat: 51.5074, lon: -0.1278, city: 'London', jurisdiction: 'gb'},\n  {region: 'USA', lat: 40.7128, lon: -74.0060, city: 'New York', jurisdiction: 'us_ny'},\n  {region: 'UAE', lat: 25.2048, lon: 55.2708, city: 'Dubai', jurisdiction: 'ae'},\n  {region: 'Saudi', lat: 24.7136, lon: 46.6753, city: 'Riyadh', jurisdiction: 'sa'},\n  {region: 'Japan', lat: 35.6762, lon: 139.6503, city: 'Tokyo', jurisdiction: 'jp'},\n  {region: 'Australia', lat: -33.8688, lon: 151.2093, city: 'Sydney', jurisdiction: 'au'}\n];\nconst input = $input.first().json;\nif (input && input.region) return regions.filter(r => r.region.toLowerCase() === input.region.toLowerCase()).map(r => ({json: r}));\nreturn regions.map(r => ({json: r}));}},{
                    "name": "Loop Regions",
                    "type": "n8n-nodes-base.splitInBatches",
                    "position": [
                        750,
                        500
                    ],
                    "parameters": {
                        "batchSize": 1
                    }
                },
                {
                    "name": "OpenStreetMap Overpass",
                    "type": "n8n-nodes-base.httpRequest",
                    "position": [
                        1000,
                        500
                    ],
                    "parameters": {
                        "method": "POST",
                        "url": "https://overpass-api.de/api/interpreter",
                        "sendBody": true,
                        "contentType": "form-urlencoded",
                        "bodyParameters": {
                            "parameters": [
                                {
                                    "name": "data",
                                    "value": "=[out:json];(node[\"amenity\"=\"restaurant\"](around:10000,{{$json.lat}},{{$json.lon}});node[\"amenity\"=\"cafe\"](around:10000,{{$json.lat}},{{$json.lon}});node[\"shop\"=\"convenience\"](around:10000,{{$json.lat}},{{$json.lon}}););out body 15;"
                                }
                            ]
                        },
                        "options": {
                            "timeout": 15000,
                            "response": {
                                "response": {
                                    "neverError": true
                                }
                            }
                        }
                    },
                    "continueOnFail": true
                },
                {
                    "name": "Parse OSM",
                    "type": "n8n-nodes-base.code",
                    "position": [
                        1250,
                        500
                    ],
                    "parameters": {
                        "jsCode": "const elements = $json.elements || [];\nconst parsed = [];\nelements.forEach(place => {\n  const tags = place.tags || {};\n  if (tags.name) {\n    parsed.push({company_name: tags.name, location: `${tags['addr:city'] || $('Loop Regions').item.json.city}, ${$('Loop Regions').item.json.region}`, industry: tags.amenity === 'restaurant' ? 'restaurant' : tags.amenity === 'cafe' ? 'cafe' : 'retail', region: $('Loop Regions').item.json.region, phone: tags.phone || tags['contact:phone'] || null, website: tags.website || tags['contact:website'] || null, email: tags.email || tags['contact:email'] || null, source: 'openstreetmap'});\n  }\n});\nreturn parsed.map(p => ({json: p}));"
                    }
                },
                {
                    "name": "Check OSM Results",
                    "type": "n8n-nodes-base.if",
                    "position": [
                        1500,
                        500
                    ],
                    "parameters": {
                        "conditions": {
                            "boolean": [
                                {
                                    "value1": "={{$input.all().length > 0}}",
                                    "value2": true
                                }
                            ]
                        }
                    }
                },
                {
                    "name": "Serper Google Maps",
                    "type": "n8n-nodes-base.httpRequest",
                    "position": [
                        1750,
                        600
                    ],
                    "parameters": {
                        "method": "POST",
                        "url": "https://google.serper.dev/search",
                        "sendHeaders": true,
                        "headerParameters": {
                            "parameters": [
                                {
                                    "name": "X-API-KEY",
                                    "value": "={{$env.SERPER_API_KEY}}"
                                },
                                {
                                    "name": "Content-Type",
                                    "value": "application/json"
                                }
                            ]
                        },
                        "sendBody": true,
                        "specifyBody": "json",
                        "jsonBody": "={\"q\": \"{{$('Loop Regions').item.json.city}} restaurant cafe email contact\", \"num\": 10}",
                        "options": {
                            "timeout": 10000,
                            "response": {
                                "response": {
                                    "neverError": true
                                }
                            }
                        }
                    },
                    "continueOnFail": true
                },
                {
                    "name": "Parse Serper",
                    "type": "n8n-nodes-base.code",
                    "position": [
                        2000,
                        600
                    ],
                    "parameters": {
                        "jsCode": "const organic = $json.organic || [];\nconst parsed = [];\norganic.slice(0, 8).forEach(result => {\n  const emailMatch = result.snippet?.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/);\n  const phoneMatch = result.snippet?.match(/\\+?\\d{1,3}[\\s.-]?\\d{1,4}[\\s.-]?\\d{1,4}[\\s.-]?\\d{1,9}/);\n  parsed.push({company_name: result.title?.split('|')[0]?.split('-')[0]?.trim() || 'Unknown', location: $('Loop Regions').item.json.city + ', ' + $('Loop Regions').item.json.region, industry: 'business', region: $('Loop Regions').item.json.region, phone: phoneMatch ? phoneMatch[0] : null, website: result.link || null, email: emailMatch ? emailMatch[0] : null, source: 'serper_google'});\n});\nreturn parsed.map(p => ({json: p}));"
                    }
                },
                {
                    "name": "Check Serper Results",
                    "type": "n8n-nodes-base.if",
                    "position": [
                        2250,
                        600
                    ],
                    "parameters": {
                        "conditions": {
                            "boolean": [
                                {
                                    "value1": "={{$input.all().length > 0}}",
                                    "value2": true
                                }
                            ]
                        }
                    }
                },
                {
                    "name": "OpenCorporates",
                    "type": "n8n-nodes-base.httpRequest",
                    "position": [
                        2500,
                        700
                    ],
                    "parameters": {
                        "url": "=https://api.opencorporates.com/v0.4/companies/search?q=restaurant+cafe+retail&jurisdiction_code={{$('Loop Regions').item.json.jurisdiction}}&per_page=10",
                        "options": {
                            "timeout": 10000,
                            "response": {
                                "response": {
                                    "neverError": true
                                }
                            }
                        }
                    },
                    "continueOnFail": true
                },
                {
                    "name": "Parse OpenCorporates",
                    "type": "n8n-nodes-base.code",
                    "position": [
                        2750,
                        700
                    ],
                    "parameters": {
                        "jsCode": "const companies = $json.results?.companies || [];\nconst parsed = [];\ncompanies.forEach(item => {\n  const c = item.company;\n  parsed.push({company_name: c.name, location: `${c.registered_address?.locality || ''}, ${$('Loop Regions').item.json.region}`, industry: 'business', region: $('Loop Regions').item.json.region, phone: null, website: null, email: null, source: 'opencorporates'});\n});\nreturn parsed.map(p => ({json: p}));"
                    }
                },
                {
                    "name": "Merge Sources",
                    "type": "n8n-nodes-base.merge",
                    "position": [
                        3000,
                        550
                    ],
                    "parameters": {
                        "mode": "append"
                    }
                },
                {
                    "name": "Delay 2s",
                    "type": "n8n-nodes-base.wait",
                    "position": [
                        3250,
                        550
                    ],
                    "parameters": {
                        "resume": "after",
                        "amount": 2
                    }
                },
                {
                    "name": "Scrape Website",
                    "type": "n8n-nodes-base.httpRequest",
                    "position": [
                        3500,
                        550
                    ],
                    "parameters": {
                        "url": "={{$json.website}}",
                        "options": {
                            "timeout": 8000,
                            "response": {
                                "response": {
                                    "neverError": true,
                                    "responseFormat": "text"
                                }
                            }
                        }
                    },
                    "continueOnFail": true
                },
                {
                    "name": "Extract Contacts",
                    "type": "n8n-nodes-base.code",
                    "position": [
                        3750,
                        550
                    ],
                    "parameters": {
                        "jsCode": "const html = $json.data || '';\nconst emails = (html.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g) || []).filter(e => !e.includes('@sentry') && !e.includes('@example'));\nconst phones = html.match(/\\+?\\d{1,3}[\\s.-]?\\(?\\d{1,4}\\)?[\\s.-]?\\d{1,4}[\\s.-]?\\d{1,9}/g) || [];\nconst lead = $('Merge Sources').item.json;\nreturn [{json: {...lead, email: emails[0] || lead.email, phone: phones[0] || lead.phone, website_html: html.slice(0, 15000)}}];"
                    }
                },
                {
                    "name": "Gemini Analyzer",
                    "type": "n8n-nodes-base.httpRequest",
                    "position": [
                        4000,
                        550
                    ],
                    "parameters": {
                        "method": "POST",
                        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={{$env.GEMINI_API_KEY}}",
                        "sendBody": true,
                        "specifyBody": "json",
                        "jsonBody": "={\"contents\": [{\"parts\": [{\"text\": \"Analyze {{$json.company_name}} ({{$json.industry}}) in {{$json.location}}.\\nWebsite: {{$json.website || 'None'}}\\n\\nJSON: {\\\"business_summary\\\": \\\"1 sentence\\\", \\\"pain_points\\\": [\\\"issue1\\\", \\\"issue2\\\"], \\\"automation_opportunities\\\": [\\\"solution1\\\"], \\\"lead_quality_score\\\": 1-10}\\nJSON only.\"}]}], \"generationConfig\": {\"temperature\": 0.3, \"maxOutputTokens\": 400}}",
                        "options": {
                            "timeout": 15000
                        }
                    },
                    "continueOnFail": true
                },
                {
                    "name": "Parse Gemini",
                    "type": "n8n-nodes-base.code",
                    "position": [
                        4250,
                        550
                    ],
                    "parameters": {
                        "jsCode": "let ai = {business_summary: 'Business', pain_points: ['Manual work'], automation_opportunities: ['CRM'], lead_quality_score: 7};\ntry { const text = $json.candidates?.[0]?.content?.parts?.[0]?.text || '{}'; const match = text.match(/\\{[\\s\\S]*\\}/); if (match) ai = JSON.parse(match[0]); } catch (e) {}\nreturn [{json: {...$('Extract Contacts').item.json, ai_summary: ai.business_summary, pain_points: Array.isArray(ai.pain_points) ? ai.pain_points.join(', ') : ai.pain_points, automation_opportunities: ai.automation_opportunities, ai_score: ai.lead_quality_score || 7}}];"
                    }
                },
                {
                    "name": "Groq Personalization",
                    "type": "n8n-nodes-base.httpRequest",
                    "position": [
                        4500,
                        550
                    ],
                    "parameters": {
                        "method": "POST",
                        "url": "https://api.groq.com/openai/v1/chat/completions",
                        "sendHeaders": true,
                        "headerParameters": {
                            "parameters": [
                                {
                                    "name": "Authorization",
                                    "value": "=Bearer {{$env.GROQ_API_KEY}}"
                                },
                                {
                                    "name": "Content-Type",
                                    "value": "application/json"
                                }
                            ]
                        },
                        "sendBody": true,
                        "specifyBody": "json",
                        "jsonBody": "={\"model\": \"llama-3.1-70b-versatile\", \"messages\": [{\"role\": \"user\", \"content\": \"Sales email for {{$json.company_name}} ({{$json.industry}}) in {{$json.location}}.\\nPain: {{$json.pain_points}}\\n\\nJSON: {\\\"personalization_hook\\\": \\\"one line\\\", \\\"email_subject\\\": \\\"compelling\\\", \\\"email_body\\\": \\\"120 words\\\"}\"}], \"temperature\": 0.7, \"max_tokens\": 400}",
                        "options": {
                            "timeout": 15000
                        }
                    },
                    "continueOnFail": true
                },
                {
                    "name": "Parse Groq",
                    "type": "n8n-nodes-base.code",
                    "position": [
                        4750,
                        550
                    ],
                    "parameters": {
                        "jsCode": "let msg = {personalization_hook: 'Streamline operations', email_subject: 'Improve business', email_body: 'We help automate.'};\ntry { const text = $json.choices?.[0]?.message?.content || '{}'; const match = text.match(/\\{[\\s\\S]*\\}/); if (match) msg = JSON.parse(match[0]); } catch (e) {}\nreturn [{json: {...$('Parse Gemini').item.json, personalization_hook: msg.personalization_hook, email_subject: msg.email_subject, email_body: msg.email_body}}];"
                    }
                },
                {
                    "name": "Filter Score >5",
                    "type": "n8n-nodes-base.filter",
                    "position": [
                        5000,
                        550
                    ],
                    "parameters": {
                        "conditions": {
                            "options": {
                                "typeValidation": "strict"
                            },
                            "conditions": [
                                {
                                    "leftValue": "={{$json.ai_score}}",
                                    "rightValue": 5,
                                    "operator": {
                                        "type": "number",
                                        "operation": "gt"
                                    }
                                }
                            ]
                        }
                    }
                },
                {
                    "name": "Check Email",
                    "type": "n8n-nodes-base.if",
                    "position": [
                        5250,
                        550
                    ],
                    "parameters": {
                        "conditions": {
                            "string": [
                                {
                                    "value1": "={{$json.email}}",
                                    "operation": "regex",
                                    "value2": "^[^@]+@[^@]+\\.[^@]+$"
                                }
                            ]
                        }
                    }
                },
                {
                    "name": "Set Data",
                    "type": "n8n-nodes-base.code",
                    "position": [
                        5500,
                        450
                    ],
                    "parameters": {
                        "jsCode": "const priority = !$json.website ? 'high' : ($json.ai_score >= 8 ? 'high' : 'medium');\nreturn [{json: {...$json, priority, employee_count: Math.floor(Math.random() * 40) + 5, status: 'new'}}];"
                    }
                },
                {
                    "name": "Send Email",
                    "type": "n8n-nodes-base.emailSend",
                    "position": [
                        5750,
                        350
                    ],
                    "parameters": {
                        "fromEmail": "hello@maksoftwaresolutions.com",
                        "toEmail": "={{$json.email}}",
                        "subject": "={{$json.email_subject}}",
                        "text": "={{$json.email_body}}",
                        "replyTo": "ahad@maksoftwaresolutions.com"
                    },
                    "credentials": {
                        "smtp": "zoho_mail"
                    },
                    "continueOnFail": true
                },
                {
                    "name": "WhatsApp Draft",
                    "type": "n8n-nodes-base.code",
                    "position": [
                        5750,
                        650
                    ],
                    "parameters": {
                        "jsCode": "return [{json: {...$json, whatsapp_draft: `Hi, ${$json.personalization_hook}. Quick 15-min call?`, outreach_method: 'whatsapp'}}];"
                    }
                },
                {
                    "name": "Merge Outreach",
                    "type": "n8n-nodes-base.merge",
                    "position": [
                        6000,
                        500
                    ],
                    "parameters": {
                        "mode": "append"
                    }
                },
                {
                    "name": "Format Backend",
                    "type": "n8n-nodes-base.code",
                    "position": [
                        6250,
                        500
                    ],
                    "parameters": {
                        "jsCode": "return [{json: {company_name: $json.company_name, website: $json.website, email: $json.email, phone: $json.phone, industry: $json.industry, location: $json.location, employee_count: $json.employee_count || 10, status: 'new', priority: $json.priority, pain_points: $json.pain_points, notes: `AI: ${$json.ai_score}/10. ${$json.ai_summary}. Source: ${$json.source}`, source: $json.source}}];"
                    }
                },
                {
                    "name": "POST to MAK OS",
                    "type": "n8n-nodes-base.httpRequest",
                    "position": [
                        6500,
                        500
                    ],
                    "parameters": {
                        "method": "POST",
                        "url": "https://mak-os.onrender.com/api/leads",
                        "sendHeaders": true,
                        "headerParameters": {
                            "parameters": [
                                {
                                    "name": "Content-Type",
                                    "value": "application/json"
                                }
                            ]
                        },
                        "sendBody": true,
                        "specifyBody": "json",
                        "jsonBody": "={{$json}}",
                        "options": {
                            "timeout": 10000,
                            "response": {
                                "response": {
                                    "neverError": true
                                }
                            }
                        }
                    }
                },
                {
                    "name": "Success",
                    "type": "n8n-nodes-base.code",
                    "position": [
                        6750,
                        500
                    ],
                    "parameters": {
                        "jsCode": "console.log('âœ…', $json.company_name);\nreturn [$input];"
                    }
                }
            ],
            "connections": {
                "Schedule Trigger": {
                    "main": [
                        [
                            {
                                "node": "Initialize Regions"
                            }
                        ]
                    ]
                },
                "Manual Webhook": {
                    "main": [
                        [
                            {
                                "node": "Initialize Regions"
                            }
                        ]
                    ]
                },
                "Initialize Regions": {
                    "main": [
                        [
                            {
                                "node": "Loop Regions"
                            }
                        ]
                    ]
                },
                "Loop Regions": {
                    "main": [
                        [
                            {
                                "node": "OpenStreetMap Overpass"
                            }
                        ]
                    ]
                },
                "OpenStreetMap Overpass": {
                    "main": [
                        [
                            {
                                "node": "Parse OSM"
                            }
                        ]
                    ]
                },
                "Parse OSM": {
                    "main": [
                        [
                            {
                                "node": "Check OSM Results"
                            }
                        ]
                    ]
                },
                "Check OSM Results": {
                    "main": [
                        [
                            {
                                "node": "Merge Sources",
                                "index": 0
                            }
                        ],
                        [
                            {
                                "node": "Serper Google Maps"
                            }
                        ]
                    ]
                },
                "Serper Google Maps": {
                    "main": [
                        [
                            {
                                "node": "Parse Serper"
                            }
                        ]
                    ]
                },
                "Parse Serper": {
                    "main": [
                        [
                            {
                                "node": "Check Serper Results"
                            }
                        ]
                    ]
                },
                "Check Serper Results": {
                    "main": [
                        [
                            {
                                "node": "Merge Sources",
                                "index": 1
                            }
                        ],
                        [
                            {
                                "node": "OpenCorporates"
                            }
                        ]
                    ]
                },
                "OpenCorporates": {
                    "main": [
                        [
                            {
                                "node": "Parse OpenCorporates"
                            }
                        ]
                    ]
                },
                "Parse OpenCorporates": {
                    "main": [
                        [
                            {
                                "node": "Merge Sources",
                                "index": 2
                            }
                        ]
                    ]
                },
                "Merge Sources": {
                    "main": [
                        [
                            {
                                "node": "Delay 2s"
                            }
                        ]
                    ]
                },
                "Delay 2s": {
                    "main": [
                        [
                            {
                                "node": "Scrape Website"
                            }
                        ]
                    ]
                },
                "Scrape Website": {
                    "main": [
                        [
                            {
                                "node": "Extract Contacts"
                            }
                        ]
                    ]
                },
                "Extract Contacts": {
                    "main": [
                        [
                            {
                                "node": "Gemini Analyzer"
                            }
                        ]
                    ]
                },
                "Gemini Analyzer": {
                    "main": [
                        [
                            {
                                "node": "Parse Gemini"
                            }
                        ]
                    ]
                },
                "Parse Gemini": {
                    "main": [
                        [
                            {
                                "node": "Groq Personalization"
                            }
                        ]
                    ]
                },
                "Groq Personalization": {
                    "main": [
                        [
                            {
                                "node": "Parse Groq"
                            }
                        ]
                    ]
                },
                "Parse Groq": {
                    "main": [
                        [
                            {
                                "node": "Filter Score >5"
                            }
                        ]
                    ]
                },
                "Filter Score >5": {
                    "main": [
                        [
                            {
                                "node": "Check Email"
                            }
                        ]
                    ]
                },
                "Check Email": {
                    "main": [
                        [
                            {
                                "node": "Set Data"
                            }
                        ],
                        [
                            {
                                "node": "WhatsApp Draft"
                            }
                        ]
                    ]
                },
                "Set Data": {
                    "main": [
                        [
                            {
                                "node": "Send Email"
                            }
                        ]
                    ]
                },
                "Send Email": {
                    "main": [
                        [
                            {
                                "node": "Merge Outreach",
                                "index": 0
                            }
                        ]
                    ]
                },
                "WhatsApp Draft": {
                    "main": [
                        [
                            {
                                "node": "Merge Outreach",
                                "index": 1
                            }
                        ]
                    ]
                },
                "Merge Outreach": {
                    "main": [
                        [
                            {
                                "node": "Format Backend"
                            }
                        ]
                    ]
                },
                "Format Backend": {
                    "main": [
                        [
                            {
                                "node": "POST to MAK OS"
                            }
                        ]
                    ]
                },
                "POST to MAK OS": {
                    "main": [
                        [
                            {
                                "node": "Success"
                            }
                        ]
                    ]
                }
            },
            "settings": {
                "executionOrder": "v1"
            }
        }