{
  "name": "MAK Lead Discovery - Complete",
  "nodes": [
    {
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "position": [
        250,
        500
      ],
      "parameters": {
        "path": "discover-leads",
        "httpMethod": "POST",
        "responseMode": "onReceived"
      },
      "webhookId": "discover-leads"
    },
    {
      "name": "Initialize Regions",
      "type": "n8n-nodes-base.set",
      "position": [
        500,
        500
      ],
      "parameters": {
        "mode": "manual",
        "duplicateItem": true,
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "items",
              "value": "=[{\"region\":\"UK\",\"lat\":51.5074,\"lon\":-0.1278,\"city\":\"London\"},{\"region\":\"USA\",\"lat\":40.7128,\"lon\":-74.0060,\"city\":\"New York\"},{\"region\":\"UAE\",\"lat\":25.2048,\"lon\":55.2708,\"city\":\"Dubai\"}]",
              "type": "array"
            }
          ]
        }
      }
    },
    {
      "name": "Split Regions",
      "type": "n8n-nodes-base.splitOut",
      "position": [
        750,
        500
      ],
      "parameters": {
        "fieldName": "items"
      }
    },
    {
      "name": "OpenStreetMap Discovery",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1000,
        400
      ],
      "parameters": {
        "method": "POST",
        "url": "https://overpass-api.de/api/interpreter",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "data",
              "value": "=[out:json];(node[\"amenity\"=\"restaurant\"](around:8000,{{$json.lat}},{{$json.lon}});node[\"amenity\"=\"cafe\"](around:8000,{{$json.lat}},{{$json.lon}}););out body 12;"
            }
          ]
        },
        "options": {
          "timeout": 15000,
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "continueOnFail": true
    },
    {
      "name": "Serper Fallback",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1000,
        600
      ],
      "parameters": {
        "method": "POST",
        "url": "https://google.serper.dev/search",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{$env.SERPER_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"q\": \"restaurants in {{$json.city}}\", \"num\": 10}",
        "options": {
          "timeout": 10000,
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "continueOnFail": true
    },
    {
      "name": "Parse OSM",
      "type": "n8n-nodes-base.set",
      "position": [
        1250,
        400
      ],
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "source_data",
              "name": "source_data",
              "value": "={{$json}}",
              "type": "object"
            }
          ]
        }
      }
    },
    {
      "name": "Parse Serper",
      "type": "n8n-nodes-base.set",
      "position": [
        1250,
        600
      ],
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "source_data",
              "name": "source_data",
              "value": "={{$json}}",
              "type": "object"
            }
          ]
        }
      }
    },
    {
      "name": "Merge Sources",
      "type": "n8n-nodes-base.merge",
      "position": [
        1500,
        500
      ],
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition"
      }
    },
    {
      "name": "Extract Business Data",
      "type": "n8n-nodes-base.set",
      "position": [
        1750,
        500
      ],
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "company_name",
              "name": "company_name",
              "value": "=Test Business",
              "type": "string"
            },
            {
              "id": "location",
              "name": "location",
              "value": "={{$json.city}}, {{$json.region}}",
              "type": "string"
            },
            {
              "id": "industry",
              "name": "industry",
              "value": "=Restaurant",
              "type": "string"
            },
            {
              "id": "source",
              "name": "source",
              "value": "=openstreetmap",
              "type": "string"
            }
          ]
        }
      }
    },
    {
      "name": "Gemini AI Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2000,
        400
      ],
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key={{$env.GEMINI_API_KEY}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"contents\":[{\"parts\":[{\"text\":\"Analyze this business: {{$json.company_name}}. Identify 3 automation opportunities.\"}]}]}",
        "options": {
          "timeout": 10000,
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "continueOnFail": true
    },
    {
      "name": "Groq Personalization",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2000,
        600
      ],
      "parameters": {
        "method": "POST",
        "url": "https://api.groq.com/openai/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.GROQ_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"model\":\"mixtral-8x7b-32768\",\"messages\":[{\"role\":\"user\",\"content\":\"Create a personalized outreach hook for {{$json.company_name}}\"}]}",
        "options": {
          "timeout": 10000,
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "continueOnFail": true
    },
    {
      "name": "Combine AI Results",
      "type": "n8n-nodes-base.merge",
      "position": [
        2250,
        500
      ],
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition"
      }
    },
    {
      "name": "Format Lead",
      "type": "n8n-nodes-base.set",
      "position": [
        2500,
        500
      ],
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "company_name",
              "name": "company_name",
              "value": "={{$json.company_name}}",
              "type": "string"
            },
            {
              "id": "location",
              "name": "location",
              "value": "={{$json.location}}",
              "type": "string"
            },
            {
              "id": "industry",
              "name": "industry",
              "value": "={{$json.industry}}",
              "type": "string"
            },
            {
              "id": "source",
              "name": "source",
              "value": "={{$json.source}}",
              "type": "string"
            },
            {
              "id": "status",
              "name": "status",
              "value": "=new",
              "type": "string"
            },
            {
              "id": "priority",
              "name": "priority",
              "value": "=high",
              "type": "string"
            },
            {
              "id": "employee_count",
              "name": "employee_count",
              "value": "=15",
              "type": "number"
            },
            {
              "id": "pain_points",
              "name": "pain_points",
              "value": "=Manual operations, inefficient workflows",
              "type": "string"
            },
            {
              "id": "notes",
              "name": "notes",
              "value": "=AI-enhanced lead with personalization",
              "type": "string"
            }
          ]
        }
      }
    },
    {
      "name": "POST to MAK OS",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2750,
        500
      ],
      "parameters": {
        "method": "POST",
        "url": "https://mak-os.onrender.com/api/leads",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {
          "timeout": 10000,
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      }
    },
    {
      "name": "Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        3000,
        500
      ],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\":\"success\",\"company\":\"{{$json.company_name}}\"}"
      }
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Initialize Regions"
          }
        ]
      ]
    },
    "Initialize Regions": {
      "main": [
        [
          {
            "node": "Split Regions"
          }
        ]
      ]
    },
    "Split Regions": {
      "main": [
        [
          {
            "node": "OpenStreetMap Discovery"
          },
          {
            "node": "Serper Fallback"
          }
        ]
      ]
    },
    "OpenStreetMap Discovery": {
      "main": [
        [
          {
            "node": "Parse OSM"
          }
        ]
      ]
    },
    "Serper Fallback": {
      "main": [
        [
          {
            "node": "Parse Serper"
          }
        ]
      ]
    },
    "Parse OSM": {
      "main": [
        [
          {
            "node": "Merge Sources",
            "index": 0
          }
        ]
      ]
    },
    "Parse Serper": {
      "main": [
        [
          {
            "node": "Merge Sources",
            "index": 1
          }
        ]
      ]
    },
    "Merge Sources": {
      "main": [
        [
          {
            "node": "Extract Business Data"
          }
        ]
      ]
    },
    "Extract Business Data": {
      "main": [
        [
          {
            "node": "Gemini AI Analysis"
          },
          {
            "node": "Groq Personalization"
          }
        ]
      ]
    },
    "Gemini AI Analysis": {
      "main": [
        [
          {
            "node": "Combine AI Results",
            "index": 0
          }
        ]
      ]
    },
    "Groq Personalization": {
      "main": [
        [
          {
            "node": "Combine AI Results",
            "index": 1
          }
        ]
      ]
    },
    "Combine AI Results": {
      "main": [
        [
          {
            "node": "Format Lead"
          }
        ]
      ]
    },
    "Format Lead": {
      "main": [
        [
          {
            "node": "POST to MAK OS"
          }
        ]
      ]
    },
    "POST to MAK OS": {
      "main": [
        [
          {
            "node": "Success"
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true
  }
}